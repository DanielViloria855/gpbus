<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Página de Pasajero</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #e8f5e9; color: #2e7d32; font-family: Arial, sans-serif; margin:0; padding:0; }
    .container { background:#fff; border-radius:15px; padding:25px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin:30px auto; max-width: 900px;}
    .logo-container { text-align:center; margin-top:20px; }
    h1 { text-align:center; color:#1b5e20; font-weight:bold; margin-bottom:20px; }
    #map { height:400px; width:100%; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    .btn-green { background-color:#2e7d32; color:#fff; border:none; border-radius:8px; padding:10px; font-size:16px; transition:.3s; }
    .btn-green:hover { background-color:#1b5e20; }
    select.form-select { border:2px solid #2e7d32; border-radius:8px; padding:8px; font-size:16px; }
    #infoRuta { background:#f1f8e9; border-radius:12px; padding:15px; margin-top:15px; box-shadow:0 3px 7px rgba(0,0,0,0.1); display:none; }
    .info-item { font-size:18px; font-weight:bold; }
  </style>
</head>
<body>
  <div class="logo-container">
    <img src="{{ url_for('static', filename='img/gp.png') }}" alt="Logo" width="120" height="90">
  </div>

  <div class="container">
    <h1>Bienvenido, {{ usuario.nombre }} (Pasajero)</h1>
    <div id="map"></div>

    <button id="getLocation" class="btn btn-green w-100 mt-3">Obtener mi ubicación</button>

    <div class="mt-3">
      <label for="destino" class="fw-bold">Selecciona tu destino:</label>
      <select id="destino" class="form-select mb-3">
        <option value="" disabled selected>Elige un destino</option>
      </select>
      <button id="trazarRuta" class="btn btn-green w-100">Trazar Ruta</button>
    </div>

    <div id="infoRuta">
      <h4>Detalles de la Ruta</h4>
      <p class="info-item"><strong>Distancia:</strong> <span id="distancia"></span></p>
      <p class="info-item"><strong>Duración:</strong> <span id="duracion"></span></p>
      <p class="info-item"><strong>Precio Estimado:</strong> $<span id="precio"></span></p>
    </div>

    <button id="startSim" class="btn btn-green w-100 mt-3" disabled>Iniciar Simulación de Bus</button>
    <button id="endTrip" class="btn btn-success w-100 mt-3" style="display:none;">Finalizar Viaje</button>

    <div id="rating" class="mt-4" style="display:none;">
      <h4 class="text-center">Califica tu viaje</h4>
      <select id="calificacion" class="form-select mb-3">
        <option value="" disabled selected>Selecciona una calificación</option>
        <option>1 - Muy malo</option>
        <option>2 - Malo</option>
        <option>3 - Regular</option>
        <option>4 - Bueno</option>
        <option>5 - Excelente</option>
      </select>
      <button id="sendRating" class="btn btn-green w-100">Enviar Calificación</button>
    </div>
  </div>

  <script>
    let map, marker, directionsService, directionsRenderer, userLocation=null;
    let busMarkers=[], routePath=[], stepIndex=0, simInterval=null;

    function initMap() {
      const defaultLoc={ lat:6.2442, lng:-75.5812 };
      map=new google.maps.Map(document.getElementById("map"), { center:defaultLoc, zoom:12 });
      marker=new google.maps.Marker({ position:defaultLoc, map });
      directionsService=new google.maps.DirectionsService();
      directionsRenderer=new google.maps.DirectionsRenderer({ map });
      loadDestinos();
      fetchBuses(); setInterval(fetchBuses,5000);
    }

    function loadDestinos(){
      fetch('/get-destinos')
        .then(r=>r.json())
        .then(destinos=>{
          const sel=document.getElementById('destino');
          Object.keys(destinos).forEach(name=>{
            const opt=document.createElement('option');
            opt.value=name; opt.textContent=name;
            sel.appendChild(opt);
          });
        });
    }

    function fetchBuses(){
      fetch('/get-buses')
        .then(r=>r.json())
        .then(data=>{
          // limpiar marcadores previos
          busMarkers.forEach(m=>m.setMap(null));
          busMarkers=[];
          data.forEach(b=>{
            const m=new google.maps.Marker({
              position:{ lat:b.lat, lng:b.lng },
              map,
              icon:{ url:'https://maps.google.com/mapfiles/kml/shapes/bus.png',
                     scaledSize:new google.maps.Size(32,32) }
            });
            busMarkers.push(m);
          });
        });
    }

    document.getElementById("getLocation").onclick=()=>{
      if(navigator.geolocation){
        navigator.geolocation.getCurrentPosition(pos=>{
          userLocation={ lat:pos.coords.latitude, lng:pos.coords.longitude };
          map.setCenter(userLocation);
          marker.setPosition(userLocation);
        },err=>alert("Error al obtener ubicación: "+err.message));
      } else alert("Navegador no soporta geolocalización.");
    };

    document.getElementById("trazarRuta").onclick=()=>{
      if(!userLocation){ alert("Primero obtén tu ubicación."); return; }
      const destName=document.getElementById("destino").value;
      if(!destName){ alert("Selecciona un destino."); return; }
      const destinos=0; // no hace falta, Google toma destino por string
      directionsService.route({
        origin:userLocation,
        destination:destName,
        travelMode:google.maps.TravelMode.DRIVING
      },(res,status)=>{
        if(status==="OK"){
          directionsRenderer.setDirections(res);
          mostrarInfoRuta(res);
          // construir path
          routePath=[];
          res.routes[0].legs[0].steps.forEach(s=> s.path.forEach(p=>routePath.push(p)));
          document.getElementById("startSim").disabled=false;
        } else alert("No se pudo calcular la ruta.");
      });
    };

    function mostrarInfoRuta(res){
      const leg=res.routes[0].legs[0];
      const km=leg.distance.value/1000;
      document.getElementById("distancia").textContent=km.toFixed(2)+" km";
      document.getElementById("duracion").textContent=leg.duration.text;
      document.getElementById("precio").textContent=(3500+km*200).toFixed(2);
      document.getElementById("infoRuta").style.display="block";
    }

    document.getElementById("startSim").onclick=()=>{
      if(!routePath.length)return;
      if(!window.busMarker){
        window.busMarker=new google.maps.Marker({
          position:routePath[0], map,
          icon:{ url:'https://maps.google.com/mapfiles/kml/shapes/bus.png', scaledSize:new google.maps.Size(48,48) }
        });
      }
      document.getElementById("startSim").style.display="none";
      document.getElementById("endTrip").style.display="block";
      stepIndex=0;
      simInterval=setInterval(()=>{
        stepIndex++;
        if(stepIndex>=routePath.length){
          clearInterval(simInterval);
          document.getElementById("rating").style.display="block";
          return;
        }
        window.busMarker.setPosition(routePath[stepIndex]);
      },200);
    };

    document.getElementById("endTrip").onclick=()=>{
      clearInterval(simInterval);
      document.getElementById("rating").style.display="block";
      document.getElementById("endTrip").style.display="none";
    };

    document.getElementById("sendRating").onclick=()=>{
      const val=document.getElementById("calificacion").value;
      if(!val) return alert("Selecciona una calificación");
      alert(`Gracias por tu calificación: ${val}`);
      document.getElementById("rating").style.display="none";
    };
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3BqEEhWiOdduk3jnRVwR8DTEIIehTSQo&callback=initMap&libraries=places,geometry&solution_channel=GMP_QB_commutes_v3_c" async defer></script>
</body>
</html>
