<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Página de Pasajero</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <style>
    body { background-color: #e8f5e9; color: #2e7d32; font-family: Arial, sans-serif; margin:0; padding:0; }
    .container { background:#fff; border-radius:15px; padding:25px; box-shadow:0 5px 15px rgba(0,0,0,0.1); margin:30px auto; max-width: 900px;}
    .logo-container { text-align:center; margin-top:20px; }
    h1 { text-align:center; color:#1b5e20; font-weight:bold; margin-bottom:20px; }
    #map { height:400px; width:100%; border-radius:15px; box-shadow:0 4px 10px rgba(0,0,0,0.1); }
    .btn-green { background-color:#2e7d32; color:#fff; border:none; border-radius:8px; padding:10px; font-size:16px; transition:.3s; }
    .btn-green:hover { background-color:#1b5e20; }
    select.form-select { border:2px solid #2e7d32; border-radius:8px; padding:8px; font-size:16px; }
    #infoRuta { background:#f1f8e9; border-radius:12px; padding:15px; margin-top:15px; box-shadow:0 3px 7px rgba(0,0,0,0.1); display:none; }
    .info-item { font-size:18px; font-weight:bold; }
  </style>
</head>
<body>
  <div class="logo-container">
    <img src="{{ url_for('static', filename='img/gp.png') }}" alt="Logo" width="120" height="90">
  </div>

  <div class="container">
    <h1>Bienvenido, {{ usuario.nombre }} (Pasajero)</h1>
    <div id="map"></div>

    <button id="getLocation" class="btn btn-green w-100 mt-3">Obtener mi ubicación</button>
    
    <div id="infoUbicaciones" class="d-flex justify-content-between mt-3 p-3 bg-light rounded" style="border: 1px solid #2e7d32;">
      <div>
        <strong>Tu ubicación:</strong>
        <p id="direccionUsuario" class="mb-0 text-success">No disponible</p>
      </div>
      <div>
        <strong>Destino:</strong>
        <p id="nombreDestino" class="mb-0 text-success">No seleccionado</p>
      </div>
      <div class="progress mt-3" style="width:200px;">
        <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%">0%</div>
      </div>
    </div>

    <div class="mt-3">
      <label for="destino" class="fw-bold">Selecciona tu destino:</label>
      <select id="destino" class="form-select mb-3">
        <option value="" disabled selected>Elige un destino</option>
      </select>
      <button id="trazarRuta" class="btn btn-green w-100">Trazar Ruta</button>
    </div>

    <div id="infoRuta">
      <h4>Detalles de la Ruta</h4>
      <p class="info-item"><strong>Distancia:</strong> <span id="distancia"></span></p>
      <p class="info-item"><strong>Duración:</strong> <span id="duracion"></span></p>
      <p class="info-item"><strong>Precio Estimado:</strong> $<span id="precio"></span></p>
    </div>

    <button id="startSim" class="btn btn-green w-100 mt-3" disabled>Iniciar Simulación de Bus</button>
    <button id="endTrip" class="btn btn-success w-100 mt-3" style="display:none;">Finalizar Viaje</button>

    <div id="rating" class="mt-4" style="display:none;">
      <h4 class="text-center">Califica tu viaje</h4>
      <select id="calificacion" class="form-select mb-3">
        <option value="" disabled selected>Selecciona una calificación</option>
        <option>1 - Muy malo</option>
        <option>2 - Malo</option>
        <option>3 - Regular</option>
        <option>4 - Bueno</option>
        <option>5 - Excelente</option>
      </select>
      <button id="sendRating" class="btn btn-green w-100">Enviar Calificación</button>
    </div>
  </div>

  <script>
    
    let map, marker, directionsService, directionsRenderer, userLocation = null;
    let routePath = [], stepIndex = 0, simInterval = null;
    let destinosData = [], buses = [];

    const API_KEY = 'AIzaSyC3BqEEhWiOdduk3jnRVwR8DTEIIehTSQo';

    
    class Bus {
  constructor(pathCoords) {
    this.rawPath = pathCoords;
    this.snappedPath = [];
    this.marker = new google.maps.Marker({
      position: pathCoords[0],
      map,
      icon: {
        url: 'https://maps.google.com/mapfiles/kml/shapes/bus.png',
        scaledSize: new google.maps.Size(32, 32)
      }
    });
    this.snapToRoads();
  }

  async snapToRoads() {
    const pathStr = this.rawPath.map(p => `${p.lat},${p.lng}`).join('|');
    const url = `https://roads.googleapis.com/v1/snapToRoads?path=${pathStr}&interpolate=true&key=${API_KEY}`;
    const res = await fetch(url);
    const json = await res.json();
    this.snappedPath = json.snappedPoints.map(pt => ({
      lat: pt.location.latitude,
      lng: pt.location.longitude
    }));
    this.animate();  
  }

  animate() {
    if (!this.snappedPath.length) return;
    
    const totalDuration = this.snappedPath.length * 5000; 
    
    let startTime = null;

    const step = timestamp => {
      if (!startTime) startTime = timestamp;
      const elapsed = timestamp - startTime;
      const t = (elapsed % totalDuration) / totalDuration;  // 0..1 ciclando
      const floatIndex = t * (this.snappedPath.length - 1);
      const idx = Math.floor(floatIndex);
      const frac = floatIndex - idx;

      const p0 = this.snappedPath[idx];
      const p1 = this.snappedPath[(idx + 1) % this.snappedPath.length];

      const lat = p0.lat + (p1.lat - p0.lat) * frac;
      const lng = p0.lng + (p1.lng - p0.lng) * frac;
      this.marker.setPosition({ lat, lng });

      requestAnimationFrame(step);
    };

    requestAnimationFrame(step);
  }
}


  
    function initMap() {
      const defaultLoc = { lat:6.2442, lng:-75.5812 };
      map = new google.maps.Map(document.getElementById("map"), { center:defaultLoc, zoom:12 });
      marker = new google.maps.Marker({ position:defaultLoc, map });
      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({ map });

      loadDestinos();
      setupEventListeners();
      fetchBusSimulations();
    }

    
    function loadDestinos() {
      fetch('/get-destinos')
        .then(r => r.json())
        .then(data => {
          destinosData = data;
          const sel = document.getElementById('destino');
          sel.innerHTML = '<option value="" disabled selected>Elige un destino</option>';
          data.forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.nombre;
            opt.textContent = d.nombre;
            sel.appendChild(opt);
          });
        });
    }

  
    function setupEventListeners() {
      document.getElementById("getLocation").onclick = getUserLocation;
      document.getElementById("trazarRuta").onclick = calculateRoute;
     document.getElementById("startSim").onclick = () => {
  const idRuta = document.getElementById("destino").value;
  if (!idRuta) return alert("Selecciona primero una ruta");

  fetch('/iniciar_simulacion', {
    method: 'POST',
    credentials: 'same-origin',    // ← aquí
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ id_ruta: idRuta })
  })
  .then(r => {
    if (!r.ok) throw new Error(`HTTP ${r.status}`);
    return r.json();
  })
  .then(json => {
    if (json.status === 'ok') {
      startTripSimulation();
    } else {
      alert("Error al guardar el viaje: " + json.message);
    }
  })
  .catch(err => {
    alert("Error de red o JSON inválido: " + err);
  });
};

      document.getElementById("endTrip").onclick = endTripSimulation;
      document.getElementById("sendRating").onclick = submitRating;
    }


    function getUserLocation() {
      navigator.geolocation.getCurrentPosition(pos => {
        userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.panTo(userLocation);
        marker.setPosition(userLocation);

        new google.maps.Geocoder().geocode({ location: userLocation }, (res, st) => {
          document.getElementById('direccionUsuario').textContent =
            (st === 'OK' && res[0]) ? res[0].formatted_address : 'Sin dirección';
        });
      }, e => alert('Error geolocalizando: '+e.message));
    }


    function calculateRoute() {
      if (!userLocation) return alert('Primero obtén tu ubicación');
      const dest = document.getElementById('destino').value;
      if (!dest) return alert('Selecciona un destino');
      document.getElementById('nombreDestino').textContent = dest;
      const d = destinosData.find(x => x.nombre === dest);
      directionsService.route({
        origin: userLocation,
        destination: { lat: d.lat, lng: d.lng },
        travelMode: 'DRIVING'
      }, (res, st) => {
        if (st==='OK') {
          directionsRenderer.setDirections(res);
          showRouteInfo(res);

          routePath = [];
          res.routes[0].overview_path.forEach(p => routePath.push({ lat:p.lat(), lng:p.lng() }));
          document.getElementById('startSim').disabled = false;
        } else alert('No se pudo calcular ruta');
      });
    }

    function showRouteInfo(res) {
      const leg = res.routes[0].legs[0];
      document.getElementById('distancia').textContent = (leg.distance.value/1000).toFixed(2)+' km';
      document.getElementById('duracion').textContent = leg.duration.text;
      document.getElementById('precio').textContent = (3500 + (leg.distance.value/1000*200)).toFixed(2);
      document.getElementById('infoRuta').style.display = 'block';
    }


    function startTripSimulation() {
      if (!routePath.length) return;
      window.busMarker = new google.maps.Marker({
        position: routePath[0], map,
        icon:{ url:'https://maps.google.com/mapfiles/kml/shapes/bus.png', scaledSize:new google.maps.Size(48,48) }
      });
      document.getElementById('startSim').style.display='none';
      document.getElementById('endTrip').style.display='block';
      stepIndex = 0;
      simInterval = setInterval(() => {
        if (stepIndex >= routePath.length) return clearInterval(simInterval);
        window.busMarker.setPosition(routePath[stepIndex++]);
        const prog = Math.floor(stepIndex/routePath.length*100);
        document.getElementById('progressBar').style.width = prog+'%';
        document.getElementById('progressBar').textContent = prog+'%';
      }, 200);
    }

    function endTripSimulation() {
      clearInterval(simInterval);
      document.getElementById('rating').style.display='block';
      document.getElementById('endTrip').style.display='none';
      window.busMarker.setMap(null);
    }

    function submitRating() {
      const v = document.getElementById('calificacion').value;
      if (!v) return alert('Selecciona calificación');
      alert('Gracias por tu calificación: '+v);
      document.getElementById('rating').style.display='none';
    }


    function fetchBusSimulations() {
   
      for (let i=0; i<3; i++) {
        const demoPath = generarRutaDePrueba(i);
        buses.push(new Bus(demoPath));
      }
    }
    function generarRutaDePrueba(i) {
      const base = { lat:6.2442 + 0.01*i, lng:-75.5812 + 0.01*i };
      return [
        base,
        { lat: base.lat + 0.005, lng: base.lng + 0.01 },
        { lat: base.lat + 0.01, lng: base.lng + 0.015 }
      ];
    }
  </script>

  <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC3BqEEhWiOdduk3jnRVwR8DTEIIehTSQo&callback=initMap&libraries=places,geometry">
  </script>
</body>
</html>
